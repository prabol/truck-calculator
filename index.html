<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Tras dla Pojazdów Ciężarowych</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .icon { width: 1.25rem; height: 1.25rem; stroke: currentColor; fill: none; stroke-width: 2; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="max-w-6xl mx-auto p-6 bg-white min-h-screen">
        
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center gap-3">
                <svg class="icon text-blue-600" viewBox="0 0 24 24">
                    <rect x="1" y="3" width="15" height="13"/>
                    <polygon points="16,8 20,8 23,11 23,16 16,16 16,8"/>
                    <circle cx="5.5" cy="18.5" r="2.5"/>
                    <circle cx="18.5" cy="18.5" r="2.5"/>
                </svg>
                Kalkulator Tras dla Pojazdów Ciężarowych
            </h1>
            <p class="text-gray-600">Oblicz dystanse i opłaty drogowe dla tras ciężarowych</p>
        </div>

        <!-- HERE API Configuration -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
                <svg class="icon text-blue-600 mt-0.5" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="2" y1="12" x2="22" y2="12"/>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
                <div class="flex-1">
                    <h3 class="font-medium text-blue-800 mb-3">Konfiguracja HERE Maps API</h3>
                    
                    <div class="flex items-center gap-4 mb-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="useRealAPI" class="mr-2 h-4 w-4 text-blue-600">
                            <span class="text-blue-700">Użyj rzeczywistego API HERE Maps</span>
                        </label>
                    </div>
                    
                    <div id="apiConfig" class="space-y-4" style="display: none;">
                        <div>
                            <label class="flex items-center gap-2 text-sm font-medium text-blue-700 mb-2">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <circle cx="7" cy="15" r="3"/>
                                    <path d="m10 15 11-11"/>
                                    <path d="m21 6-2-2"/>
                                    <path d="m15 12-2-2"/>
                                </svg>
                                Klucz API HERE Maps:
                            </label>
                            <input type="password" id="hereApiKey" placeholder="Wklej swój klucz API tutaj..." 
                                   class="w-full px-3 py-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500">
                            <p class="text-sm text-blue-600 mt-1">
                                Uzyskaj darmowy klucz na: <a href="https://platform.here.com/" target="_blank" class="underline">platform.here.com</a>
                            </p>
                        </div>
                        
                        <!-- Truck Parameters -->
                        <div class="bg-white rounded p-3 border border-blue-200">
                            <h4 class="font-medium text-blue-800 mb-2">Parametry pojazdu ciężarowego</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                <div>
                                    <label class="block text-blue-700 mb-1">Masa (kg)</label>
                                    <input type="number" id="grossWeight" value="40000" class="w-full px-2 py-1 border border-blue-200 rounded text-xs">
                                </div>
                                <div>
                                    <label class="block text-blue-700 mb-1">Wysokość (cm)</label>
                                    <input type="number" id="height" value="400" class="w-full px-2 py-1 border border-blue-200 rounded text-xs">
                                </div>
                                <div>
                                    <label class="block text-blue-700 mb-1">Szerokość (cm)</label>
                                    <input type="number" id="width" value="250" class="w-full px-2 py-1 border border-blue-200 rounded text-xs">
                                </div>
                                <div>
                                    <label class="block text-blue-700 mb-1">Długość (cm)</label>
                                    <input type="number" id="length" value="1600" class="w-full px-2 py-1 border border-blue-200 rounded text-xs">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <p id="simulationNote" class="text-sm text-blue-600">
                        Obecnie używane są symulowane dane. Włącz API dla rzeczywistych tras.
                    </p>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
                <svg class="icon text-yellow-600 mt-0.5" viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                <div class="flex-1">
                    <h3 class="font-medium text-yellow-800 mb-2">Instrukcje</h3>
                    <p class="text-yellow-700 text-sm mb-3">
                        Jeśli masz plik Excel, zapisz go jako CSV: Plik → Zapisz jako → CSV UTF-8
                    </p>
                    <div class="flex gap-2 flex-wrap">
                        <button id="loadTestData" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                            Załaduj dane testowe
                        </button>
                        <button id="fixCSVButton" class="bg-orange-600 text-white px-4 py-2 rounded text-sm hover:bg-orange-700">
                            Napraw plik CSV
                        </button>
                        <button id="clearData" class="bg-gray-600 text-white px-4 py-2 rounded text-sm hover:bg-gray-700" style="display: none;">
                            Wyczyść
                        </button>
                    </div>
                    <p class="text-xs text-yellow-700 mt-2">
                        Jeśli plik CSV nie wczytuje się poprawnie, użyj przycisku "Napraw plik CSV"
                    </p>
                </div>
            </div>
        </div>

        <!-- File Upload -->
        <div class="mb-8">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors">
                <svg class="icon mx-auto h-12 w-12 text-gray-400 mb-4" viewBox="0 0 24 24">
                    <path d="M7 16l4-4 4 4M7 8l4-4 4 4"/>
                </svg>
                <label for="fileUpload" class="cursor-pointer">
                    <span class="text-lg font-medium text-gray-700">Kliknij aby wybrać plik CSV</span>
                    <input id="fileUpload" type="file" accept=".csv" class="hidden">
                </label>
                <p id="fileName" class="mt-2 text-sm text-gray-500" style="display: none;"></p>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorBox" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3" style="display: none;">
            <svg class="icon text-red-500 mt-0.5" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <div id="errorText" class="text-red-700"></div>
        </div>

        <!-- Data Preview -->
        <div id="dataPreview" class="mb-8" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Podgląd danych</h2>
            <div class="bg-gray-50 rounded-lg p-4 overflow-x-auto">
                <table id="previewTable" class="min-w-full text-sm"></table>
            </div>
        </div>

        <!-- Process Button -->
        <div id="processSection" class="mb-8 text-center" style="display: none;">
            <button id="processRoutes" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors flex items-center gap-2 mx-auto">
                <svg class="icon" viewBox="0 0 24 24">
                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                    <line x1="9" y1="15" x2="9.01" y2="15"/>
                    <line x1="15" y1="15" x2="15.01" y2="15"/>
                </svg>
                <span id="processButtonText">Oblicz trasy (Symulacja)</span>
            </button>
            <p id="apiKeyWarning" class="text-sm text-red-600 mt-2" style="display: none;">
                Wprowadź klucz HERE API
            </p>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="mb-8" style="display: none;">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Wyniki obliczeń</h2>
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                <table id="resultsTable" class="min-w-full"></table>
            </div>
        </div>

        <!-- Download Button -->
        <div id="downloadSection" class="text-center mb-8" style="display: none;">
            <button id="downloadButton" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 mx-auto">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M7 8l4 4 4-4M7 16l4 4 4-4"/>
                </svg>
                Pobierz zaktualizowany plik CSV
            </button>
        </div>

        <!-- Info Section -->
        <div class="bg-blue-50 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-900 mb-3">Informacje</h3>
            <ul class="text-blue-800 space-y-2 text-sm">
                <li>• <strong>Symulacja:</strong> Oszacowane dane na podstawie typowych tras</li>
                <li>• <strong>HERE API:</strong> Rzeczywiste trasy z ograniczeniami dla ciężarówek</li>
                <li>• <strong>Bezpłatny plan HERE:</strong> 250,000 zapytań/miesiąc</li>
                <li>• <strong>Bezpieczeństwo:</strong> Wszystkie dane przetwarzane lokalnie</li>
                <li>• <strong>"Napraw plik CSV":</strong> Automatycznie konwertuje polski format Excel</li>
            </ul>
        </div>

    </div>

    <script>
        // Global variables
        let currentData = [];
        let currentResults = [];
        let isProcessing = false;

        // Test data
        const testData = [
            ['Item Name', 'Loading Location Country', 'Supply Location Street', 'Loading Location City', 'Loading Location Postal code', 'Delivery Location Country', 'Delivery Location Street', 'Delivery Location City', 'Delivery Location Postal code', 'Dystans w km', 'Opłaty drogowe'],
            ['L2416_HAMBURG - HEILBRONN_AMBIENT', 'GERMANY', 'PORGESRING 13', 'HAMBURG', '22113', 'GERMANY', 'HAFENSTRASSE 95', 'HEILBRONN', '74076', '', ''],
            ['L2417_HUEGELSHEIM - PLOIESTI_AMBIENT', 'GERMANY', 'CALGARY AVENUE A400', 'HUEGELSHEIM', '76549', 'ROMANIA', 'REPUBLICII AVENUE,NO 291', 'PLOIESTI', '100568', '', ''],
            ['L2418_HULL - PLOIESTI_AMBIENT', 'UNITED KINGDOM', 'HEDON ROAD', 'HULL', 'HU9 5NX', 'ROMANIA', 'REPUBLICII AVENUE,NO 291', 'PLOIESTI', '100568', '', ''],
            ['L2107_TER APELKANAAL - PLOIESTI_AMBIENT', 'NETHERLANDS', 'LOODSWEG 5', 'TER APELKANAAL', '9563 TW', 'ROMANIA', 'REPUBLICII AVENUE,NO 291', 'PLOIESTI', '100568', '', '']
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
        });

        function initializeEventListeners() {
            // API toggle
            document.getElementById('useRealAPI').addEventListener('change', function(e) {
                const apiConfig = document.getElementById('apiConfig');
                const simulationNote = document.getElementById('simulationNote');
                
                if (e.target.checked) {
                    apiConfig.style.display = 'block';
                    simulationNote.style.display = 'none';
                } else {
                    apiConfig.style.display = 'none';
                    simulationNote.style.display = 'block';
                }
                updateProcessButton();
            });

            // API key input
            document.getElementById('hereApiKey').addEventListener('input', updateProcessButton);

            // Load test data
            document.getElementById('loadTestData').addEventListener('click', loadTestData);

            // Clear data
            document.getElementById('clearData').addEventListener('click', clearData);

            // File upload
            document.getElementById('fileUpload').addEventListener('change', handleFileUpload);

            // Process routes
            document.getElementById('processRoutes').addEventListener('click', processRoutes);

            // Download button
            document.getElementById('downloadButton').addEventListener('click', downloadResults);

            // Fix CSV button
            document.getElementById('fixCSVButton').addEventListener('click', fixCSVFile);
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorBox').style.display = 'flex';
        }

        function hideError() {
            document.getElementById('errorBox').style.display = 'none';
        }

        function loadTestData() {
            currentData = testData;
            console.log('Test data loaded:', currentData.length, 'rows');
            displayDataPreview();
            document.getElementById('fileName').textContent = 'Załadowano dane testowe';
            document.getElementById('fileName').style.display = 'block';
            document.getElementById('clearData').style.display = 'inline-block';
            hideError();
        }

        function clearData() {
            currentData = [];
            currentResults = [];
            document.getElementById('dataPreview').style.display = 'none';
            document.getElementById('processSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('downloadSection').style.display = 'none';
            document.getElementById('fileName').style.display = 'none';
            document.getElementById('clearData').style.display = 'none';
            document.getElementById('fileUpload').value = '';
            hideError();
        }

        function parseCSV(text) {
            console.log('=== CSV PARSER ===');
            console.log('Input length:', text.length);
            console.log('First 200 chars:', text.substring(0, 200));
            
            // Sprawdź czy to standardowy format
            let lines = text.split(/\r?\n/).filter(line => line.trim());
            console.log('Initial line split:', lines.length, 'lines');
            
            // Wykryj polski format (mało linii + dużo średników)
            const totalSemicolons = (text.match(/;/g) || []).length;
            const totalCommas = (text.match(/,/g) || []).length;
            
            if (lines.length <= 3 && totalSemicolons > 20) {
                console.log('POLISH FORMAT DETECTED - please use Fix CSV button');
                showError('Wykryto polski format CSV. Użyj przycisku "Napraw plik CSV" poniżej.');
                return [];
            }
            
            // Filtruj puste linie
            lines = lines.filter(line => {
                const trimmed = line.trim();
                return trimmed && !trimmed.match(/^[;,]*$/);
            });
            
            if (lines.length === 0) return [];
            
            // Wykryj separator
            const firstLine = lines[0];
            const semicolons = (firstLine.match(/;/g) || []).length;
            const commas = (firstLine.match(/,/g) || []).length;
            const separator = semicolons > commas ? ';' : ',';
            
            console.log(`Using separator: "${separator}"`);
            
            // Parsuj linie
            const result = lines.map((line, i) => {
                const cells = line.split(separator).map(cell => cell.trim().replace(/^"|"$/g, ''));
                return cells;
            });
            
            console.log('Parsed:', result.length, 'rows');
            return result;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.csv')) {
                showError('Proszę wybierz plik CSV. Jeśli masz Excel, zapisz go jako CSV.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = parseCSV(e.target.result);
                    if (csvData.length > 0) {
                        currentData = csvData;
                        displayDataPreview();
                        document.getElementById('fileName').textContent = 'Wybrano: ' + file.name;
                        document.getElementById('fileName').style.display = 'block';
                        document.getElementById('clearData').style.display = 'inline-block';
                        hideError();
                    }
                } catch (error) {
                    showError('Błąd czytania pliku CSV: ' + error.message);
                }
            };
            reader.readAsText(file, 'utf-8');
        }

        function displayDataPreview() {
            if (currentData.length === 0) return;

            const table = document.getElementById('previewTable');
            let html = '<thead><tr class="bg-gray-100">';
            
            // Headers
            currentData[0].forEach(header => {
                html += `<th class="px-3 py-2 text-left font-medium text-gray-700">${header || ''}</th>`;
            });
            html += '</tr></thead><tbody>';

            // Data rows (first 5)
            for (let i = 1; i < Math.min(6, currentData.length); i++) {
                const row = currentData[i];
                if (row && row.some(cell => cell && cell.toString().trim())) {
                    html += '<tr class="border-t border-gray-200">';
                    row.forEach(cell => {
                        html += `<td class="px-3 py-2 text-gray-600">${cell || '-'}</td>`;
                    });
                    html += '</tr>';
                }
            }
            html += '</tbody>';

            table.innerHTML = html;
            document.getElementById('dataPreview').style.display = 'block';
            document.getElementById('processSection').style.display = 'block';
            updateProcessButton();
        }

        function updateProcessButton() {
            const useRealAPI = document.getElementById('useRealAPI').checked;
            const hereApiKey = document.getElementById('hereApiKey').value;
            const processButton = document.getElementById('processRoutes');
            const buttonText = document.getElementById('processButtonText');
            const warning = document.getElementById('apiKeyWarning');

            if (useRealAPI) {
                buttonText.textContent = 'Oblicz trasy (HERE API)';
                if (!hereApiKey) {
                    processButton.disabled = true;
                    warning.style.display = 'block';
                } else {
                    processButton.disabled = false;
                    warning.style.display = 'none';
                }
            } else {
                buttonText.textContent = 'Oblicz trasy (Symulacja)';
                processButton.disabled = false;
                warning.style.display = 'none';
            }
        }

        async function processRoutes() {
            if (isProcessing || currentData.length < 2) return;

            isProcessing = true;
            const processButton = document.getElementById('processRoutes');
            const buttonText = document.getElementById('processButtonText');
            
            processButton.disabled = true;
            buttonText.textContent = 'Obliczanie...';
            
            try {
                currentResults = [];
                const useRealAPI = document.getElementById('useRealAPI').checked;
                const rows = currentData.slice(1).filter(row => row.some(cell => cell && cell.toString().trim()));

                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || row.length === 0) continue;

                    const loadingCity = row[3] || '';
                    const deliveryCity = row[7] || '';

                    if (!loadingCity || !deliveryCity || loadingCity.trim() === '' || deliveryCity.trim() === '') {
                        currentResults.push({
                            rowIndex: i,
                            from: loadingCity || 'Brak miasta załadunku',
                            to: deliveryCity || 'Brak miasta rozładunku',
                            distance: 0,
                            tollCost: 0,
                            status: 'Błąd: Brak miast'
                        });
                        continue;
                    }

                    const fromAddress = [row[2], row[3], row[4], row[1]].filter(x => x && x.trim()).join(', ');
                    const toAddress = [row[6], row[7], row[8], row[5]].filter(x => x && x.trim()).join(', ');
                    
                    let result;
                    if (useRealAPI) {
                        result = await calculateRouteWithHERE(fromAddress, toAddress);
                    } else {
                        result = await calculateRouteSimulated(fromAddress, toAddress);
                    }
                    
                    currentResults.push({
                        rowIndex: i,
                        from: fromAddress,
                        to: toAddress,
                        distance: result.distance,
                        tollCost: result.tollCost,
                        duration: result.duration,
                        status: result.success ? (useRealAPI ? 'HERE API' : 'Symulacja') : `Błąd: ${result.error}`
                    });
                }

                displayResults();
                
            } catch (error) {
                showError('Błąd przetwarzania: ' + error.message);
            } finally {
                isProcessing = false;
                processButton.disabled = false;
                updateProcessButton();
            }
        }

        async function calculateRouteWithHERE(fromAddress, toAddress) {
            try {
                const hereApiKey = document.getElementById('hereApiKey').value;
                
                // Geocoding
                const origin = await geocodeAddress(fromAddress, hereApiKey);
                const destination = await geocodeAddress(toAddress, hereApiKey);
                
                console.log(`Geocoded: ${fromAddress} -> ${origin}, ${toAddress} -> ${destination}`);
                
                // Route calculation
                const params = new URLSearchParams({
                    transportMode: 'truck',
                    origin: origin,
                    destination: destination,
                    return: 'summary,tollCosts',
                    'truck[grossWeight]': document.getElementById('grossWeight').value,
                    'truck[height]': document.getElementById('height').value,
                    'truck[width]': document.getElementById('width').value,
                    'truck[length]': document.getElementById('length').value,
                    'truck[axleCount]': '4',
                    'truck[tunnelCategory]': 'B',
                    apikey: hereApiKey
                });
                
                const routeUrl = `https://router.hereapi.com/v8/routes?${params}`;
                const response = await fetch(routeUrl);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HERE API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const data = await response.json();
                if (!data.routes || data.routes.length === 0) {
                    throw new Error('Nie znaleziono trasy');
                }
                
                const route = data.routes[0];
                const summary = route.sections[0].summary;
                const distanceKm = Math.round(summary.length / 1000);
                const durationMinutes = Math.round(summary.duration / 60);
                
                let tollCost = 0;
                if (route.tollCosts && route.tollCosts.length > 0) {
                    tollCost = route.tollCosts.reduce((sum, toll) => sum + (toll.cost || 0), 0);
                    tollCost = Math.round(tollCost * 100) / 100;
                } else {
                    tollCost = Math.round(distanceKm * 0.08 * 100) / 100;
                }
                
                return { distance: distanceKm, tollCost, duration: durationMinutes, success: true };
                
            } catch (error) {
                console.error('HERE API error:', error);
                return { distance: 0, tollCost: 0, success: false, error: error.message };
            }
        }

        async function geocodeAddress(address, apiKey) {
            const url = `https://geocode.search.hereapi.com/v1/geocode?q=${encodeURIComponent(address)}&apiKey=${apiKey}`;
            
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Geocoding failed: ${response.status}`);
            
            const data = await response.json();
            if (!data.items || data.items.length === 0) {
                throw new Error(`Nie znaleziono adresu: ${address}`);
            }
            
            const location = data.items[0].position;
            return `${location.lat},${location.lng}`;
        }

        async function calculateRouteSimulated(fromAddress, toAddress) {
            await new Promise(resolve => setTimeout(resolve, 300));
            
            const routeMap = {
                'hamburg_heilbronn': { distance: 520, tollCost: 45.20 },
                'huegelsheim_ploiesti': { distance: 1450, tollCost: 125.80 },
                'hull_ploiesti': { distance: 2150, tollCost: 185.50 },
                'ter_apelkanaal_ploiesti': { distance: 1680, tollCost: 142.30 }
            };

            const from = fromAddress.toLowerCase();
            const to = toAddress.toLowerCase();
            
            if (from.includes('hamburg') && to.includes('heilbronn')) {
                return { ...routeMap.hamburg_heilbronn, success: true };
            }
            if (from.includes('huegelsheim') && to.includes('ploiesti')) {
                return { ...routeMap.huegelsheim_ploiesti, success: true };
            }
            if (from.includes('hull') && to.includes('ploiesti')) {
                return { ...routeMap.hull_ploiesti, success: true };
            }
            if (from.includes('ter apelkanaal') && to.includes('ploiesti')) {
                return { ...routeMap.ter_apelkanaal_ploiesti, success: true };
            }

            return { distance: 1000, tollCost: 80, success: true };
        }

        function displayResults() {
            if (currentResults.length === 0) return;

            const table = document.getElementById('resultsTable');
            const useRealAPI = document.getElementById('useRealAPI').checked;
            
            let html = '<thead class="bg-gray-50"><tr>';
            html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Wiersz</th>';
            html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Z</th>';
            html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Do</th>';
            html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dystans (km)</th>';
            html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Opłaty (€)</th>';
            if (useRealAPI) {
                html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Czas (min)</th>';
            }
            html += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>';
            html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

            currentResults.forEach((result, index) => {
                html += '<tr class="hover:bg-gray-50">';
                html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.rowIndex + 2}</td>`;
                html += `<td class="px-6 py-4 text-sm text-gray-600 max-w-xs truncate">${result.from}</td>`;
                html += `<td class="px-6 py-4 text-sm text-gray-600 max-w-xs truncate">${result.to}</td>`;
                html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.distance > 0 ? result.distance.toLocaleString() : '-'}</td>`;
                html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.tollCost > 0 ? '€' + result.tollCost.toFixed(2) : '-'}</td>`;
                
                if (useRealAPI) {
                    const timeStr = result.duration ? `${Math.floor(result.duration / 60)}h ${result.duration % 60}m` : '-';
                    html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${timeStr}</td>`;
                }
                
                let statusClass = 'bg-red-100 text-red-800';
                if (result.status === 'HERE API') statusClass = 'bg-green-100 text-green-800';
                else if (result.status === 'Symulacja') statusClass = 'bg-blue-100 text-blue-800';
                
                html += `<td class="px-6 py-4 whitespace-nowrap">`;
                html += `<span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${result.status}</span>`;
                html += `</td></tr>`;
            });

            html += '</tbody>';
            table.innerHTML = html;
            
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('downloadSection').style.display = 'block';
        }

        function downloadResults() {
            if (currentData.length === 0 || currentResults.length === 0) return;

            const updatedData = JSON.parse(JSON.stringify(currentData)); // Deep copy
            
            currentResults.forEach(result => {
                const rowIndex = result.rowIndex + 1;
                if (updatedData[rowIndex]) {
                    // Ensure row has enough columns
                    while (updatedData[rowIndex].length < 11) {
                        updatedData[rowIndex].push('');
                    }
                    updatedData[rowIndex][9] = result.distance; // Column J
                    updatedData[rowIndex][10] = result.tollCost; // Column K
                }
            });

            // Convert to CSV
            const csvContent = updatedData.map(row => 
                row.map(cell => {
                    const str = (cell || '').toString();
                    return str.includes(',') || str.includes('"') || str.includes('\n') 
                        ? `"${str.replace(/"/g, '""')}"` 
                        : str;
                }).join(',')
            ).join('\n');

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'PRZEETAG_zaktualizowany.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function fixCSVFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const content = event.target.result;
                    console.log('=== FIXING CSV FILE ===');
                    console.log('Original content length:', content.length);
                    
                    // Fix Polish CSV format
                    const fixedContent = fixPolishCSVFormat(content);
                    
                    if (fixedContent) {
                        // Download fixed file
                        const blob = new Blob([fixedContent], { type: 'text/csv;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = file.name.replace('.csv', '_naprawiony.csv');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        alert('Plik został naprawiony i pobrany jako "' + file.name.replace('.csv', '_naprawiony.csv') + '". Teraz wczytaj naprawiony plik do aplikacji.');
                    } else {
                        showError('Nie udało się naprawić pliku CSV. Sprawdź format pliku.');
                    }
                };
                reader.readAsText(file, 'utf-8');
            };
            input.click();
        }

        function fixPolishCSVFormat(content) {
            console.log('Fixing Polish CSV format...');
            console.log('First 300 chars:', content.substring(0, 300));
            
            // Check if it's single-line format with semicolons
            const lines = content.split(/\r?\n/).filter(l => l.trim());
            const totalSemicolons = (content.match(/;/g) || []).length;
            
            if (lines.length <= 3 && totalSemicolons > 20) {
                console.log('Processing Polish single-line format');
                
                // Take the full content as one line
                const fullLine = content.replace(/\r?\n/g, '').trim();
                
                // Split by pattern that indicates start of new record: ,L[digits]_
                const recordPattern = /,(?=L\d+_)/g;
                const parts = fullLine.split(recordPattern);
                console.log('Split into', parts.length, 'parts');
                
                const fixedLines = [];
                
                for (let i = 0; i < parts.length; i++) {
                    let part = parts[i].trim();
                    
                    // Remove leading/trailing commas
                    part = part.replace(/^,+|,+$/g, '');
                    
                    if (part && !part.match(/^;*$/)) {
                        // Convert semicolons to commas for standard CSV
                        const standardLine = part.replace(/;/g, ',');
                        
                        // Only add if line contains meaningful data
                        if (standardLine.includes('Item Name') || 
                            standardLine.includes('HAMBURG') || 
                            standardLine.includes('PLOIESTI') || 
                            standardLine.includes('HULL') || 
                            standardLine.includes('APELKANAAL')) {
                            fixedLines.push(standardLine);
                            console.log(`Fixed line ${fixedLines.length}:`, standardLine.substring(0, 100) + '...');
                        }
                    }
                }
                
                console.log('Total fixed lines:', fixedLines.length);
                return fixedLines.join('\n');
            }
            
            // Fallback: just convert semicolons to commas
            console.log('Using fallback: semicolon to comma replacement');
            return content.split(/\r?\n/)
                .filter(line => line.trim() && !line.match(/^[;,]*$/))
                .map(line => line.replace(/;/g, ','))
                .join('\n');
        }
    </script>
</body>
</html>